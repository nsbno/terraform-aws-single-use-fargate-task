## Single Use Fargate Task
This module provides a way of simply running ad-hoc containers in Fargate.

The module creates a Lambda that can be called to run a command of your choosing in a container of your choice with a volume of S3-mounted content.

The task can optionally be used inside an AWS Step Functions state machine -- reporting success or failure to the state machine based on the exit code of the user-supplied shell command.

### Working Directory
Short notes on the working directory of the container:
- If neither `content` nor `mountpoints` are supplied, the working directory is an empty directory `/tmp/workspace/entrypoint`.
- If `content` is supplied, or `mountpoints` is supplied and contains only a single key-value pair, the working directory of the container will be inside the unzipped archive.
- If `mountpoints` contains multiple key-value pairs, the working directory of the container will be one level above the unzipped archives.

### Expected Attributes
The lambda expects a json input with the following attributes

#### state_machine_id (Optional)
The name of a Step Function state machine that uses the Lambda function. The Fargate task family will be prefixed with this value (and `state`, if supplied).

#### state (Optional)
The name of the Step Function state that invokes the Lambda function. The Fargate task family will be prefixed with this value (and `state_machine_id`, if supplied).

#### token (Optional)
A token generated by a task in a Step Function. Used to report the outcome of the Fargate task to the Step Function task.

#### cmd_to_run (Optional)
A command to be run in the container - this will be run after any content has been unzipped

#### content (Optional)
The S3 URI of a ZIP file to be unzipped into a folder mounted at `/tmp/workspace/entrypoint/content`.

_(Note: The attribute `mountpoints` and `content` are mutually exclusive. Only 0 or exactly one of them can be used)._

#### mountpoints (Optional)
An object containing different mountpoints and their associated S3 ZIP files, e.g.:
```json
"mountpoints": {
  "<mount-name>": "<s3-uri>",
  "<mount-name>": "<s3-uri>"
}
```
Each ZIP file is unzipped to `/tmp/workspace/entrypoint/<mount-name>`.

_(Note: The attribute `mountpoints` and `content` are mutually exclusive. Only 0 or exactly one of them can be used)._

#### task_cpu (Optional)
The task CPU (CPU units or vCPUs) for the Fargate task, defaults to `"256"`. (_Supported values can be found here: https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-cpu-memory-error.html._)

#### task_memory (Optional)
The task memory (MiB) for the Fargate task, defaults to `"512"`. (_Supported values can be found here: https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-cpu-memory-error.html._)

#### credentials_secret_arn (Optional)
The ARN of an AWS Secrets Manager secret that contains private registry credentials. This can be used to authenticate pulls against Docker Hub, etc. The secret needs to contain a `username` and `password` key. (_NOTE: Make sure that the task execution role is allowed to read and decrypt the secret_).

#### task_role_arn (Optional\*)
The arn of the role the task will assume when running.

_\*Required if the Lambda is used in a Step Functions state machine with the `token` attribute passed in as Lambda input._

#### task_execution_role_arn
The arn of the role given to Fargate to run tasks - this is typically a role with the managed `AmazonECSTaskExecutionRolePolicy` policy attached.

#### ecs_cluster
The name of the ECS cluster on which to run the Fargate task.

#### image
The Docker URI of the container image to launch.

#### subnets
A list of subnets into which this Fargate container can be launched.


###### Example
```json
{
  "token": "<step_function_task_token>",
  "state": "<step_function_state>",
  "state_machine_id": "<step_function_state_machine_name>",
  "cmd_to_run": "echo \"Hello World\"",
  "content": "<s3_uri>",
  "ecs_cluster": "test-single-tasks",
  "image": "vydev/terraform:0.12.20",
  "subnets": [
    "<subnet-1>",
    "<subnet-2>",
    "<subnet-2>"
  ],
  "task_execution_role_arn": "test-ECSTaskExecutionRole",
  "task_role_arn": "<task_role_arn>"
}
```
