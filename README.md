## Single Use Fargate Task
This module provides a way of simply running ad-hoc containers in Fargate.

The module creates a Lambda that can be called to run a command of your choosing in a container of your choice with a volume of S3-mounted content.

The task can optionally be used inside an AWS Step Functions state machine -- reporting success or failure to the state machine based on the exit code of the user-supplied shell command.

### Working Directory
Short notes on the working directory of the container:
- If neither `content` nor `mountpoints` are supplied, the working directory is an empty directory `/tmp/workspace/entrypoint`.
- If `content` is supplied, or `mountpoints` is supplied and contains only a single key-value pair, the working directory of the container will be inside the unzipped archive.
- If `mountpoints` contains multiple key-value pairs, the working directory of the container will be one level above the unzipped archives.

### Expected Attributes
The lambda expects a json input with the following attributes

#### log_stream_prefix (Optional)
A prefix to use when naming the log streams created by the Fargate task, as well as ephemeral the task definitions.

(_Note: If you're calling the Lambda in an AWS Step Functions state machine, you can dynamically construct this input by using the Amazon States language (e.g., `"log_stream_prefix.$": "States.Format('{}/{}/{}', $$.StateMachine.Name, $$.Execution.Name, $$.State.Name)"`_).

#### token (Optional)
A token generated by a task in an AWS Step Functions state machine. Used to report the outcome of the Fargate task back to the respective AWS Step Functions task.

#### send_error_logs_to_stepfunctions (Optional)
If enabled, a snippet of the shell output of the Fargate task will be sent back to the AWS Step Functions task on failure. Defaults to `true`. Only applicable if the Lambda is called in an AWS Step Functions state machine and the `token` parameter is set.

#### cmd_to_run (Optional)
A command to be run in the container - this will be run after any content has been unzipped

#### content (Optional)
The S3 URI of a ZIP file to be unzipped into a folder mounted at `/tmp/workspace/entrypoint/content`.

_(Note: The attribute `mountpoints` and `content` are mutually exclusive. Only 0 or exactly one of them can be used)._

#### mountpoints (Optional)
An object containing different mountpoints and their associated S3 ZIP files, e.g.:
```json
"mountpoints": {
  "<mount-name>": "<s3-uri>",
  "<mount-name>": "<s3-uri>"
}
```
Each ZIP file is unzipped to `/tmp/workspace/entrypoint/<mount-name>`.

_(Note: The attribute `mountpoints` and `content` are mutually exclusive. Only 0 or exactly one of them can be used)._

#### metric_namespace (Optional)
An optional CloudWatch metric namespace to use for publishing CloudWatch custom metrics signaling success or failure of a given Fargate task. Both `metric_namespace` and `metric_dimensions` must be set for metrics to be published.

_(Note: The task role used must have a policy attached allowing it to publish metrics to CloudWatch, i.e., `cloudwatch:PutMetricData`)_

#### metric_dimensions (Optional)
A map of dimensions to use for the CloudWatch custom metrics published. Both `metric_namespace` and `metric_dimensions` must be set for metrics to be published. (If used in an AWS Step Function state machine, an example value `"metric_dimensions": { "StateMachineName.$": "$$.StateMachine.Name", "StateName.$": "$$.State.Name" }`).

_(Note: The task role used must have a policy attached allowing it to publish metrics to CloudWatch, i.e., `cloudwatch:PutMetricData`)_

#### task_cpu (Optional)
The task CPU (CPU units or vCPUs) for the Fargate task, defaults to `"256"`. (_Supported values can be found here: https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-cpu-memory-error.html._)

#### task_memory (Optional)
The task memory (MiB) for the Fargate task, defaults to `"512"`. (_Supported values can be found here: https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-cpu-memory-error.html._)

#### credentials_secret_arn (Optional)
The ARN of an AWS Secrets Manager secret that contains private registry credentials. This can be used to authenticate pulls against Docker Hub, etc. The secret needs to contain a `username` and `password` key. (_NOTE: Make sure that the task execution role is allowed to read and decrypt the secret_).

#### assign_public_ip (Optional)
Whether to assign a public IP to the Elastic Network Interface of the Fargate task.

#### security_groups (Optional)
A list of IDs of security groups associated with the Fargate task. If not specified, the default security group for the VPC will be used.

#### task_role_arn (Optional\*)
The arn of the role the task will assume when running.

_\*Required if `metric_namespace` and `metric_dimensions` are set, or if the Lambda is used in a Step Functions state machine with the `token` attribute passed in as Lambda input._

#### task_execution_role_arn
The arn of the role given to Fargate to run tasks - this is typically a role with the managed `AmazonECSTaskExecutionRolePolicy` policy attached.

#### ecs_cluster
The name of the ECS cluster on which to run the Fargate task.

#### image
The Docker URI of the container image to launch.

#### subnets
A list of subnets into which this Fargate container can be launched.


###### Example
```json
{
  "token": "<step_function_task_token>",
  "cmd_to_run": "echo \"Hello World\"",
  "content": "<s3_uri>",
  "ecs_cluster": "test-single-tasks",
  "image": "vydev/terraform:0.12.20",
  "subnets": [
    "<subnet-1>",
    "<subnet-2>",
    "<subnet-2>"
  ],
  "task_execution_role_arn": "test-ECSTaskExecutionRole",
  "task_role_arn": "<task_role_arn>"
}
```
